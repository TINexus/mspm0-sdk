<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sensorless FOC Motor Control Library Overview &mdash; Sensorless FOC Motor Control User Guide 1.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="DRV8323RS GUI User Guide" href="drv8323rs/DRV8323RS_GUI_User_Guide.html" />
    <link rel="prev" title="MSPM0 Sensorless FOC Software User’s Guide" href="MSPM0_Sensorless_FOC_Software_Users_Guide.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Sensorless FOC Motor Control User Guide
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="MSPM0_Sensorless_FOC_Software_Users_Guide.html">MSPM0 Sensorless FOC Software User’s Guide</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Sensorless FOC Motor Control Library Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#software-overview">1. Software Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#application-layer-overview">1.1 Application Layer Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hal-module">1.2 HAL Module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#motor-driver-module">1.3 Motor Driver Module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#motor-driver-pin-association">Motor Driver Pin Association</a></li>
<li class="toctree-l4"><a class="reference internal" href="#motor-driver-apis">Motor Driver APIs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sensorless-foc-library-module">1.4 Sensorless FOC Library Module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Overview</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#mspm0-driverlib-overview">1.5 MSPM0 DriverLib Overview</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="drv8323rs/DRV8323RS_GUI_User_Guide.html">DRV8323RS GUI User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="drv8323rs/DRV8323RS_Hardware_User_Guide.html">DRV8323RS Hardware User Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Sensorless FOC Motor Control User Guide</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Sensorless FOC Motor Control Library Overview</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="sensorless-foc-motor-control-library-overview">
<h1>Sensorless FOC Motor Control Library Overview<a class="headerlink" href="#sensorless-foc-motor-control-library-overview" title="Permalink to this heading">¶</a></h1>
<section id="software-overview">
<h2>1. Software Overview<a class="headerlink" href="#software-overview" title="Permalink to this heading">¶</a></h2>
<p>Sensorless Field-Oriented Control (FOC) Library is made of three main layers: Application layer, HAL Layer, and MSPM0 DriverLib.</p>
<figure class="align-default" id="id2">
<img alt="Sensorless FOC Architecture" src="../_images/Library-Architecture.jpg" />
<figcaption>
<p><span class="caption-number">Fig. 8 </span><span class="caption-text">Sensorless FOC Architecture</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<section id="application-layer-overview">
<h3>1.1 Application Layer Overview<a class="headerlink" href="#application-layer-overview" title="Permalink to this heading">¶</a></h3>
<p>The user specific applications (such as GUI) are present in this layer. From this layer, various instances of motor driver modules can be configured and used. If the user needs to perform any hardware specific actions, the user is recommended to use the APIs from HAL module.</p>
</section>
<section id="hal-module">
<h3>1.2 HAL Module<a class="headerlink" href="#hal-module" title="Permalink to this heading">¶</a></h3>
<section id="overview">
<h4>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h4>
<p>The Hardware Abstraction Layer (HAL) creates an abstraction layer that provides APIs to configure different pins and peripherals. The goal of using HAL is to abstract all device specific configurations which simplifies porting of the library to various hardware by minimizing the updates needed to other components. The HAL is meant to abstract only the required pins or peripherals required for the application while still having flexibility and scalability for porting to other MSPM0 MCUs or motor drivers.</p>
<p>HAL is designed to have specific number of pins or channels associated with a peripheral. For example, consider the case of GPIOs. HAL has enum HAL_GPIO_OUT_PIN which has all the GPIO output pins as members as shown below.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/*! @enum HAL_GPIO_OUT_PIN */
typedef enum{
    /*! Index associated to output GPIO PIN 0 */
    HAL_GPIO_OUT_PIN_0 = 0,
    /*! Index associated to output GPIO PIN 1 */
    HAL_GPIO_OUT_PIN_1,
    /*! Total number of output GPIO pins */
    HAL_GPIO_OUT_PIN_MAX,
}HAL_GPIO_OUT_PIN;
</pre></div>
</div>
<p>To map the HAL GPIO pins to the real hardware pins, a structure is used which is indexed by the members of the HAL_GPIO_OUT_PIN enum. This structure stores various members like the port instance, pin name, etc. See below the gpioOUT structure which holds data on the port and pin.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gpioOUT</span><span class="p">[</span><span class="n">HAL_GPIO_OUT_PIN_0</span><span class="p">]</span><span class="o">.</span><span class="n">iomux</span>   <span class="o">=</span> <span class="n">GENERIC_GPIO_OUT_PINO_0_IOMUX</span><span class="p">;</span>
<span class="n">gpioOUT</span><span class="p">[</span><span class="n">HAL_GPIO_OUT_PIN_0</span><span class="p">]</span><span class="o">.</span><span class="n">port</span>    <span class="o">=</span> <span class="n">GENERIC_GPIO_OUT_PORT</span><span class="p">;</span>
<span class="n">gpioOUT</span><span class="p">[</span><span class="n">HAL_GPIO_OUT_PIN_0</span><span class="p">]</span><span class="o">.</span><span class="n">pin</span>     <span class="o">=</span> <span class="n">GENERIC_GPIO_OUT_PINO_0_PIN</span><span class="p">;</span>
</pre></div>
</div>
<p>Note that GENERIC_GPIO_OUT_PINO_0_PIN is defined in the TI SysConfig generated files the specific line is shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#define GENERIC_GPIO_OUT_PINO_0_PIN                             (DL_GPIO_PIN_26)</span>
</pre></div>
</div>
<p>Thus, HAL_GPIO_OUT_PIN_0 indirectly refers to DL_GPIO_PIN_0, but the advantage of this mapping is that since TI SysConfig controls the generation of the GENERIC_GPIO_OUT_PINO_0_PIN, it is very easy to change the pin in the TI SysConfig GUI. The HAL automatically follows this without the user having to change any code in the HAL layer.</p>
<p>As seen above, when accessing the hardware through the HAL, we need to pass a HAL specific enum like HAL_GPIO_OUT_PIN_0. These enums are stored in the instances that access the HAL layer. In the case of the DRV8323RS motor driver, the instances of the important pins are initialized with its pins assigned to the HAL enums as shown in the snippet below.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">drv8323rs</span><span class="o">.</span><span class="n">enable</span>  <span class="o">=</span> <span class="n">HAL_GPIO_OUT_PIN_0</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">nfault</span>  <span class="o">=</span> <span class="n">HAL_PWM_FAULT_0</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">spi</span>     <span class="o">=</span> <span class="n">HAL_SPI_CHANNEL_0</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">spiCS</span>   <span class="o">=</span> <span class="n">HAL_SPI_CS_2</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">vsenvm</span>  <span class="o">=</span> <span class="n">HAL_ADC_CHANNEL_1</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">isena</span>   <span class="o">=</span> <span class="n">HAL_ADC_CHANNEL_2</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">isenb</span>   <span class="o">=</span> <span class="n">HAL_ADC_CHANNEL_0</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">isenc</span>   <span class="o">=</span> <span class="n">HAL_ADC_CHANNEL_3</span><span class="p">;</span>
</pre></div>
</div>
<p>If the ENABLE pin needs to be set high, the API DRV8323RS_enable() is used and passes the DRV8323RS instance with it. The code snippet is shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">DRV8323RS_enable</span><span class="p">(</span><span class="n">DRV8323RS_Instance</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">/*</span> <span class="n">Enable</span> <span class="n">the</span> <span class="n">DRV8323RS</span> <span class="o">*/</span>
    <span class="n">HAL_setGPIOVal</span><span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">,</span> <span class="n">HAL_GPIO_VALUE_HIGH</span><span class="p">);</span>

    <span class="o">/*</span> <span class="n">Startup</span> <span class="n">delay</span> <span class="k">for</span> <span class="n">the</span> <span class="n">DRV8323RS</span> <span class="n">SPI</span> <span class="n">to</span> <span class="n">be</span> <span class="n">ready</span> <span class="o">*/</span>
    <span class="n">HAL_delayMilliSeconds</span><span class="p">(</span><span class="n">DRV8323RS_SPI_READY_DELAY_MS</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When DRV8323RS_enable() interacts with the HAL layer, it passes the member of the DRV8323RS instance. This is the same concept for using other HAL APIs such as the timer, SPI, DAC, etc. The user is free to expand the HAL’s API to support other peripherals and features of the MSPM0 but it is strongly recommended not to modify existing API to ensure easy migration to new versions of this library.</p>
</section>
</section>
<section id="motor-driver-module">
<h3>1.3 Motor Driver Module<a class="headerlink" href="#motor-driver-module" title="Permalink to this heading">¶</a></h3>
<p>Motor Driver Module uses the HAL APIs to motor driver specific operations APIs like SPI read, SPI write, voltage and current measurements. The idea of this module is to be independent of the hardware and use the HAL APIs to perform the hardware tasks specific to the motor driver.</p>
<section id="motor-driver-pin-association">
<h4>Motor Driver Pin Association<a class="headerlink" href="#motor-driver-pin-association" title="Permalink to this heading">¶</a></h4>
<p>The user before using the Motor Driver module is expected to specify the HAL enums mapped to the motor driver instance. See the below code snippet.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">Assign</span> <span class="n">the</span> <span class="n">pins</span> <span class="n">specific</span> <span class="k">for</span> <span class="n">the</span> <span class="n">DRV</span> <span class="o">*/</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">enable</span>  <span class="o">=</span> <span class="n">HAL_GPIO_OUT_PIN_0</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">nfault</span>  <span class="o">=</span> <span class="n">HAL_PWM_FAULT_0</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">spi</span>     <span class="o">=</span> <span class="n">HAL_SPI_CHANNEL_0</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">spiCS</span>   <span class="o">=</span> <span class="n">HAL_SPI_CS_2</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">vsenvm</span>  <span class="o">=</span> <span class="n">HAL_ADC_CHANNEL_1</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">isena</span>   <span class="o">=</span> <span class="n">HAL_ADC_CHANNEL_2</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">isenb</span>   <span class="o">=</span> <span class="n">HAL_ADC_CHANNEL_0</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">isenc</span>   <span class="o">=</span> <span class="n">HAL_ADC_CHANNEL_3</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="motor-driver-apis">
<h4>Motor Driver APIs<a class="headerlink" href="#motor-driver-apis" title="Permalink to this heading">¶</a></h4>
<p>The Motor Driver Module provides simple APIs which the user can use along with an instance of the motor drive module. The motor driver module APIs also handles the motor driver specific logic while keeping the APIs generic, thus the user can use different motor drivers and not worry of any difference in the internal logic. For example, below is an API for updating the SPI registers in the drv8323rs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">DRV8323RS_spiUpdateRegister</span><span class="p">(</span><span class="n">DRV8323RS_Instance</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span>
                      <span class="n">DRV8323RS_REG_ADDR</span> <span class="n">addr</span><span class="p">,</span> <span class="n">uint32_t</span> <span class="n">mask</span><span class="p">,</span> <span class="n">uint16_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint16_t</span> <span class="n">dataValue</span><span class="p">;</span>
    <span class="n">dataValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint16_t</span><span class="p">)</span> <span class="n">DRV8323RS_spiRead</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
    <span class="n">dataValue</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
    <span class="n">dataValue</span> <span class="o">|=</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">DRV8323RS_spiWrite</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">dataValue</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note from the above code snippet that any bit in the spi register in the DRV8323RS can be updated. The register address can be different for different devices, but here the enumerator DRV8323RS_REG_ADDR is used so the user doesn’t need to know the address of each register.</p>
</section>
</section>
<section id="sensorless-foc-library-module">
<h3>1.4 Sensorless FOC Library Module<a class="headerlink" href="#sensorless-foc-library-module" title="Permalink to this heading">¶</a></h3>
<section id="id1">
<h4>Overview<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h4>
<p>The Sensorless FOC library contains generic algorithms for 3-phase sensorless FOC motor control. This module has APIs that the user can use to configure and control the FOC motor control. This module takes care of setting the PWM modulations based on the FOC algorithm. This module uses the HAL APIs for any using any hardware resources. The user is required to map the HAL PWM channels for the FOC module. Below is the code snippet that allocates the HAL PWM channels to the foc module.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">Assign</span> <span class="n">the</span> <span class="n">pins</span> <span class="n">specific</span> <span class="k">for</span> <span class="n">FOC</span> <span class="o">*/</span>
<span class="n">foc</span><span class="o">.</span><span class="n">pwmAHal</span> <span class="o">=</span> <span class="n">HAL_PWM_CHANNEL_1</span><span class="p">;</span>
<span class="n">foc</span><span class="o">.</span><span class="n">pwmBHal</span> <span class="o">=</span> <span class="n">HAL_PWM_CHANNEL_2</span><span class="p">;</span>
<span class="n">foc</span><span class="o">.</span><span class="n">pwmCHal</span> <span class="o">=</span> <span class="n">HAL_PWM_CHANNEL_0</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
<section id="mspm0-driverlib-overview">
<h3>1.5 MSPM0 DriverLib Overview<a class="headerlink" href="#mspm0-driverlib-overview" title="Permalink to this heading">¶</a></h3>
<p>MSPM0 DriverLib is a set of fully functional APIs used to configure, control, and manipulate the hardware peripherals of the MSPM0 platform. Please refer to the DriverLib documentation for more information.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="MSPM0_Sensorless_FOC_Software_Users_Guide.html" class="btn btn-neutral float-left" title="MSPM0 Sensorless FOC Software User’s Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="drv8323rs/DRV8323RS_GUI_User_Guide.html" class="btn btn-neutral float-right" title="DRV8323RS GUI User Guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 1995-2023, Texas Instruments Incorporated. All rights reserved.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>