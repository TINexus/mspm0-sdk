<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sensorless FOC Motor Control Library Overview &mdash; Sensorless FOC Motor Control User Guide 1.0 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../_static/doctools.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="DRV8323RS GUI User Guide" href="drv8323rs/DRV8323RS_GUI_User_Guide_CN.html" />
    <link rel="prev" title="Sensorless FOC Motor Control User Guide" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> Sensorless FOC Motor Control User Guide
          </a>
              <div class="version">
                1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Sensorless FOC Motor Control Library Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#software-overview">1. Software Overview</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#application-layer-overview">1.1 Application Layer Overview</a></li>
<li class="toctree-l3"><a class="reference internal" href="#hal-module">1.2 HAL Module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#overview">Overview</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#motor-driver-module">1.3 Motor Driver Module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#motor-driver-pin-association">Motor Driver Pin Association</a></li>
<li class="toctree-l4"><a class="reference internal" href="#motor-driver-apis">Motor Driver APIs</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#sensorless-foc-library-module">1.4 Sensorless FOC Library Module</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id1">Overview</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#mspm0-driverlib-overview">1.5 MSPM0 DriverLib Overview</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#software-user-guide">2. Software User Guide</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#setting-the-motor-parameters">2.1 Setting the Motor Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#setting-the-system-parameters">2.2 Setting the System Parameters</a></li>
<li class="toctree-l3"><a class="reference internal" href="#selecting-the-build-levels">2.3 Selecting the Build levels</a></li>
<li class="toctree-l3"><a class="reference internal" href="#important-note">Important Note</a></li>
<li class="toctree-l3"><a class="reference internal" href="#variables-for-controlling-motor">2.4 Variables for controlling motor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-the-motor">2.5 Running the motor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tuning-the-motor">2.6 Tuning the motor</a></li>
<li class="toctree-l3"><a class="reference internal" href="#tuning-pi-controllers">Tuning PI controllers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#logging-the-variables">2.7 Logging the variables</a></li>
<li class="toctree-l3"><a class="reference internal" href="#access-spi-register">2.8 Access SPI Register</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#api-guide">3. API Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="#known-issues">4. Known Issues</a></li>
<li class="toctree-l2"><a class="reference internal" href="#supported-devices">5. Supported Devices</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#drv8323rs">DRV8323RS</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="drv8323rs/DRV8323RS_GUI_User_Guide_CN.html">DRV8323RS GUI User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="drv8323rs/DRV8323RS_Hardware_User_Guide_CN.html">DRV8323RS Hardware User Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Sensorless FOC Motor Control User Guide</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Sensorless FOC Motor Control Library Overview</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="sensorless-foc-motor-control-library-overview">
<h1>Sensorless FOC Motor Control Library Overview<a class="headerlink" href="#sensorless-foc-motor-control-library-overview" title="Permalink to this heading">¶</a></h1>
<section id="software-overview">
<h2>1. Software Overview<a class="headerlink" href="#software-overview" title="Permalink to this heading">¶</a></h2>
<p>Sensorless Field-Oriented Control (FOC) Library is made of three main layers: Application layer, HAL Layer, and MSPM0 DriverLib.</p>
<figure class="align-default" id="id2">
<img alt="Sensorless FOC Architecture" src="../_images/Library-Architecture.jpg" />
<figcaption>
<p><span class="caption-number">Fig. 1 </span><span class="caption-text">Sensorless FOC Architecture</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<section id="application-layer-overview">
<h3>1.1 Application Layer Overview<a class="headerlink" href="#application-layer-overview" title="Permalink to this heading">¶</a></h3>
<p>The user specific applications (such as GUI) are present in this layer. From this layer, various instances of motor driver modules can be configured and used. If the user needs to perform any hardware specific actions, the user is recommended to use the APIs from HAL module.</p>
</section>
<section id="hal-module">
<h3>1.2 HAL Module<a class="headerlink" href="#hal-module" title="Permalink to this heading">¶</a></h3>
<section id="overview">
<h4>Overview<a class="headerlink" href="#overview" title="Permalink to this heading">¶</a></h4>
<p>The Hardware Abstraction Layer (HAL) creates an abstraction layer that provides APIs to configure different pins and peripherals. The goal of using HAL is to abstract all device specific configurations which simplifies porting of the library to various hardware by minimizing the updates needed to other components. The HAL is meant to abstract only the required pins or peripherals required for the application while still having flexibility and scalability for porting to other MSPM0 MCUs or motor drivers.</p>
<p>HAL is designed to have specific number of pins or channels associated with a peripheral. For example, consider the case of GPIOs. HAL has enum HAL_GPIO_OUT_PIN which has all the GPIO output pins as members as shown below.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/*! @enum HAL_GPIO_OUT_PIN */
typedef enum{
    /*! Index associated to output GPIO PIN 0 */
    HAL_GPIO_OUT_PIN_0 = 0,
    /*! Index associated to output GPIO PIN 1 */
    HAL_GPIO_OUT_PIN_1,
    /*! Total number of output GPIO pins */
    HAL_GPIO_OUT_PIN_MAX,
}HAL_GPIO_OUT_PIN;
</pre></div>
</div>
<p>To map the HAL GPIO pins to the real hardware pins, a structure is used which is indexed by the members of the HAL_GPIO_OUT_PIN enum. This structure stores various members like the port instance, pin name, etc. See below the gpioOUT structure which holds data on the port and pin.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">gpioOUT</span><span class="p">[</span><span class="n">HAL_GPIO_OUT_PIN_0</span><span class="p">]</span><span class="o">.</span><span class="n">iomux</span>   <span class="o">=</span> <span class="n">GENERIC_GPIO_OUT_PINO_0_IOMUX</span><span class="p">;</span>
<span class="n">gpioOUT</span><span class="p">[</span><span class="n">HAL_GPIO_OUT_PIN_0</span><span class="p">]</span><span class="o">.</span><span class="n">port</span>    <span class="o">=</span> <span class="n">GENERIC_GPIO_OUT_PORT</span><span class="p">;</span>
<span class="n">gpioOUT</span><span class="p">[</span><span class="n">HAL_GPIO_OUT_PIN_0</span><span class="p">]</span><span class="o">.</span><span class="n">pin</span>     <span class="o">=</span> <span class="n">GENERIC_GPIO_OUT_PINO_0_PIN</span><span class="p">;</span>
</pre></div>
</div>
<p>Note that GENERIC_GPIO_OUT_PINO_0_PIN is defined in the TI SysConfig generated files the specific line is shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#define GENERIC_GPIO_OUT_PINO_0_PIN                             (DL_GPIO_PIN_26)</span>
</pre></div>
</div>
<p>Thus, HAL_GPIO_OUT_PIN_0 indirectly refers to DL_GPIO_PIN_0, but the advantage of this mapping is that since TI SysConfig controls the generation of the GENERIC_GPIO_OUT_PINO_0_PIN, it is very easy to change the pin in the TI SysConfig GUI. The HAL automatically follows this without the user having to change any code in the HAL layer.</p>
<p>As seen above, when accessing the hardware through the HAL, we need to pass a HAL specific enum like HAL_GPIO_OUT_PIN_0. These enums are stored in the instances that access the HAL layer. In the case of the DRV8323RS motor driver, the instances of the important pins are initialized with its pins assigned to the HAL enums as shown in the snippet below.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">drv8323rs</span><span class="o">.</span><span class="n">enable</span>  <span class="o">=</span> <span class="n">HAL_GPIO_OUT_PIN_0</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">nfault</span>  <span class="o">=</span> <span class="n">HAL_PWM_FAULT_0</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">spi</span>     <span class="o">=</span> <span class="n">HAL_SPI_CHANNEL_0</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">spiCS</span>   <span class="o">=</span> <span class="n">HAL_SPI_CS_2</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">vsenvm</span>  <span class="o">=</span> <span class="n">HAL_ADC_CHANNEL_1</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">isena</span>   <span class="o">=</span> <span class="n">HAL_ADC_CHANNEL_2</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">isenb</span>   <span class="o">=</span> <span class="n">HAL_ADC_CHANNEL_0</span><span class="p">;</span>
</pre></div>
</div>
<p>If the ENABLE pin needs to be set high, the API DRV8323RS_enable() is used and passes the DRV8323RS instance with it. The code snippet is shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">DRV8323RS_enable</span><span class="p">(</span><span class="n">DRV8323RS_Instance</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
    <span class="o">/*</span> <span class="n">Enable</span> <span class="n">the</span> <span class="n">DRV8323RS</span> <span class="o">*/</span>
    <span class="n">HAL_setGPIOVal</span><span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">,</span> <span class="n">HAL_GPIO_VALUE_HIGH</span><span class="p">);</span>

    <span class="o">/*</span> <span class="n">Startup</span> <span class="n">delay</span> <span class="k">for</span> <span class="n">the</span> <span class="n">DRV8323RS</span> <span class="n">SPI</span> <span class="n">to</span> <span class="n">be</span> <span class="n">ready</span> <span class="o">*/</span>
    <span class="n">HAL_delayMilliSeconds</span><span class="p">(</span><span class="n">DRV8323RS_SPI_READY_DELAY_MS</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When DRV8323RS_enable() interacts with the HAL layer, it passes the member of the DRV8323RS instance. This is the same concept for using other HAL APIs such as the timer, SPI, DAC, etc. The user is free to expand the HAL’s API to support other peripherals and features of the MSPM0 but it is strongly recommended not to modify existing API to ensure easy migration to new versions of this library.</p>
</section>
</section>
<section id="motor-driver-module">
<h3>1.3 Motor Driver Module<a class="headerlink" href="#motor-driver-module" title="Permalink to this heading">¶</a></h3>
<p>Motor Driver Module uses the HAL APIs to motor driver specific operations APIs like SPI read, SPI write, voltage and current measurements. The idea of this module is to be independent of the hardware and use the HAL APIs to perform the hardware tasks specific to the motor driver.</p>
<section id="motor-driver-pin-association">
<h4>Motor Driver Pin Association<a class="headerlink" href="#motor-driver-pin-association" title="Permalink to this heading">¶</a></h4>
<p>The user before using the Motor Driver module is expected to specify the HAL enums mapped to the motor driver instance. See the below code snippet.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">Assign</span> <span class="n">the</span> <span class="n">pins</span> <span class="n">specific</span> <span class="k">for</span> <span class="n">the</span> <span class="n">DRV</span> <span class="o">*/</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">enable</span>  <span class="o">=</span> <span class="n">HAL_GPIO_OUT_PIN_0</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">nfault</span>  <span class="o">=</span> <span class="n">HAL_PWM_FAULT_0</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">spi</span>     <span class="o">=</span> <span class="n">HAL_SPI_CHANNEL_0</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">spiCS</span>   <span class="o">=</span> <span class="n">HAL_SPI_CS_2</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">vsenvm</span>  <span class="o">=</span> <span class="n">HAL_ADC_CHANNEL_1</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">isena</span>   <span class="o">=</span> <span class="n">HAL_ADC_CHANNEL_2</span><span class="p">;</span>
<span class="n">drv8323rs</span><span class="o">.</span><span class="n">isenb</span>   <span class="o">=</span> <span class="n">HAL_ADC_CHANNEL_0</span><span class="p">;</span>
</pre></div>
</div>
</section>
<section id="motor-driver-apis">
<h4>Motor Driver APIs<a class="headerlink" href="#motor-driver-apis" title="Permalink to this heading">¶</a></h4>
<p>The Motor Driver Module provides simple APIs which the user can use along with an instance of the motor drive module. The motor driver module APIs also handles the motor driver specific logic while keeping the APIs generic, thus the user can use different motor drivers and not worry of any difference in the internal logic. For example, below is an API for updating the SPI registers in the drv8323rs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">void</span> <span class="n">DRV8323RS_spiUpdateRegister</span><span class="p">(</span><span class="n">DRV8323RS_Instance</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span>
                      <span class="n">DRV8323RS_REG_ADDR</span> <span class="n">addr</span><span class="p">,</span> <span class="n">uint32_t</span> <span class="n">mask</span><span class="p">,</span> <span class="n">uint16_t</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">uint16_t</span> <span class="n">dataValue</span><span class="p">;</span>
    <span class="n">dataValue</span> <span class="o">=</span> <span class="p">(</span><span class="n">uint16_t</span><span class="p">)</span> <span class="n">DRV8323RS_spiRead</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
    <span class="n">dataValue</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
    <span class="n">dataValue</span> <span class="o">|=</span> <span class="n">data</span><span class="p">;</span>
    <span class="n">DRV8323RS_spiWrite</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">dataValue</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Note from the above code snippet that any bit in the spi register in the DRV8323RS can be updated. The register address can be different for different devices, but here the enumerator DRV8323RS_REG_ADDR is used so the user doesn’t need to know the address of each register.</p>
</section>
</section>
<section id="sensorless-foc-library-module">
<h3>1.4 Sensorless FOC Library Module<a class="headerlink" href="#sensorless-foc-library-module" title="Permalink to this heading">¶</a></h3>
<section id="id1">
<h4>Overview<a class="headerlink" href="#id1" title="Permalink to this heading">¶</a></h4>
<p>The Sensorless FOC library contains generic algorithms for 3-phase sensorless FOC motor control. This module has APIs that the user can use to configure and control the FOC motor control. This module takes care of setting the PWM modulations based on the FOC algorithm. This module uses the HAL APIs for any using any hardware resources. The user is required to map the HAL PWM channels for the FOC module. Below is the code snippet that allocates the HAL PWM channels to the foc module.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/*</span> <span class="n">Assign</span> <span class="n">the</span> <span class="n">pins</span> <span class="n">specific</span> <span class="k">for</span> <span class="n">FOC</span> <span class="o">*/</span>
<span class="n">foc</span><span class="o">.</span><span class="n">pwmAHal</span> <span class="o">=</span> <span class="n">HAL_PWM_CHANNEL_1</span><span class="p">;</span>
<span class="n">foc</span><span class="o">.</span><span class="n">pwmBHal</span> <span class="o">=</span> <span class="n">HAL_PWM_CHANNEL_2</span><span class="p">;</span>
<span class="n">foc</span><span class="o">.</span><span class="n">pwmCHal</span> <span class="o">=</span> <span class="n">HAL_PWM_CHANNEL_0</span><span class="p">;</span>
</pre></div>
</div>
</section>
</section>
<section id="mspm0-driverlib-overview">
<h3>1.5 MSPM0 DriverLib Overview<a class="headerlink" href="#mspm0-driverlib-overview" title="Permalink to this heading">¶</a></h3>
<p>MSPM0 DriverLib is a set of fully functional APIs used to configure, control, and manipulate the hardware peripherals of the MSPM0 platform. Please refer to the DriverLib documentation for more information.</p>
</section>
</section>
<section id="software-user-guide">
<h2>2. Software User Guide<a class="headerlink" href="#software-user-guide" title="Permalink to this heading">¶</a></h2>
<p>The Sensorless FOC software can be used along with the CCS debug window. If the user wishes to use the software with GUI, please do look into the GUI user guide for the specific hardware.</p>
<section id="setting-the-motor-parameters">
<h3>2.1 Setting the Motor Parameters<a class="headerlink" href="#setting-the-motor-parameters" title="Permalink to this heading">¶</a></h3>
<p>The motor parameter can be found in the motor_parameter.h file. There are four motor parameters required for Sensorless FOC:</p>
<ul class="simple">
<li><p>Stator resistance, Rs (ohm)</p></li>
<li><p>Stator inductance, Ls (H)</p></li>
<li><p>Number of motor poles</p></li>
<li><p>Base maximum RPM of the motor</p></li>
</ul>
<figure class="align-default" id="id3">
<img alt="Locate motor parameter c file" src="../_images/FOC_MOTOR_PARAMS.jpg" />
<figcaption>
<p><span class="caption-number">Fig. 2 </span><span class="caption-text">Locate motor parameter c file</span><a class="headerlink" href="#id3" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>These parameters are defined using an #elif statement for a motor. To define these parameters for a custom motor, modify the #define statements for MOTOR_PARA_RS, MOTOR_PARA_LS, MOTOR_PARA_POLES, and MOTOR_PARA_BASE_RPM for USER_MOTOR. To add another motor, copy and paste the #elif statement below and rename USER_MOTOR to another name.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#elif (USER_MOTOR)</span>
<span class="o">/*</span> <span class="n">Define</span> <span class="n">the</span> <span class="n">electrical</span> <span class="n">motor</span> <span class="n">parameters</span> <span class="p">(</span><span class="n">User</span> <span class="n">motor</span><span class="p">)</span> <span class="o">*/</span>
<span class="o">/*</span> <span class="nd">@brief</span> <span class="n">Stator</span> <span class="n">resistance</span> <span class="p">(</span><span class="n">ohm</span><span class="p">)</span> <span class="o">*/</span>
<span class="c1">#define MOTOR_PARA_RS               1.7</span>
<span class="o">/*</span> <span class="nd">@brief</span> <span class="n">Stator</span> <span class="n">inductance</span> <span class="p">(</span><span class="n">H</span><span class="p">)</span> <span class="o">*/</span>
<span class="c1">#define MOTOR_PARA_LS               0.004</span>
<span class="o">/*</span> <span class="nd">@brief</span> <span class="n">Number</span> <span class="n">of</span> <span class="n">poles</span> <span class="o">*/</span>
<span class="c1">#define MOTOR_PARA_POLES            8</span>
<span class="o">/*</span> <span class="nd">@brief</span> <span class="n">Base</span> <span class="n">RPM</span> <span class="o">*/</span>
<span class="c1">#define MOTOR_PARA_BASE_RPM         5000</span>
</pre></div>
</div>
<p>To select a motor defined in motor_params.h, click Project -&gt; Properties in the toolbar. In the Properties window, go to Build -&gt; Arm Compiler -&gt; Predefined Symbols. The pre-defined motor name is LVSERVOMTR=1. To change the pre-defined motor name, click “Edit” and change LVSERVOMTR to another defined motor in motor_params.h, such as LVBLDCMTR or USER_MOTOR.</p>
<figure class="align-default" id="id4">
<img alt="Showing LVSERVOMTR=1 symbol" src="../_images/CCS_PREDEFINED_SYMBOL.jpg" />
<figcaption>
<p><span class="caption-number">Fig. 3 </span><span class="caption-text">Showing LVSERVOMTR=1 symbol</span><a class="headerlink" href="#id4" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="setting-the-system-parameters">
<h3>2.2 Setting the System Parameters<a class="headerlink" href="#setting-the-system-parameters" title="Permalink to this heading">¶</a></h3>
<p>The initial parameters are found in the drv8323rs-gui.h file as #define GUI_DEFAULT_XXXX. The user is required to set the parameters as per the requirement. By default the default parameters are set for LVSERVOMTR motor.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Initial Parameters</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>DRV_VDS_LVL</p></td>
<td><p>VDS comparator threshold of DRV8323RS</p></td>
</tr>
<tr class="row-odd"><td><p>DRV_SEN_LVL</p></td>
<td><p>OCP level for DRV8323RS</p></td>
</tr>
<tr class="row-even"><td><p>DRV_CSA_GAIN</p></td>
<td><p>CSA gain setting for DRV8323RS</p></td>
</tr>
<tr class="row-odd"><td><p>DRV_RSHUNT</p></td>
<td><p>Rshunt resistor value in DRV8323RS</p></td>
</tr>
<tr class="row-even"><td><p>FOC_RS</p></td>
<td><p>Selected motor phase resistance for FOC</p></td>
</tr>
<tr class="row-odd"><td><p>FOC_LS</p></td>
<td><p>Selected motor phase inductance for FOC</p></td>
</tr>
<tr class="row-even"><td><p>FOC_POLES</p></td>
<td><p>Selected motor poles for FOC</p></td>
</tr>
<tr class="row-odd"><td><p>FOC_BASE_RPM</p></td>
<td><p>Selected Base rpm for FOC</p></td>
</tr>
<tr class="row-even"><td><p>FOC_PWMFREQ</p></td>
<td><p>PWM frequency for FOC</p></td>
</tr>
<tr class="row-odd"><td><p>FOC_PWMADCSAMPLE</p></td>
<td><p>PWM counts spend in ADC sampling</p></td>
</tr>
<tr class="row-even"><td><p>FOC_CNTRLDIV</p></td>
<td><p>Control loop divider for FOC, only set to 1</p></td>
</tr>
<tr class="row-odd"><td><p>FOC_DEADBAND</p></td>
<td><p>Deadband in ns</p></td>
</tr>
<tr class="row-even"><td><p>FOC_RSHUNT</p></td>
<td><p>Rshunt resistor value</p></td>
</tr>
<tr class="row-odd"><td><p>FOC_VOLT_RATIO</p></td>
<td><p>Bus voltage conversion ratio</p></td>
</tr>
<tr class="row-even"><td><p>FOC_AMP_GAIN</p></td>
<td><p>Current amplifier gain</p></td>
</tr>
<tr class="row-odd"><td><p>FOC_KSLIDE</p></td>
<td><p>Kslide coefficient value</p></td>
</tr>
<tr class="row-even"><td><p>FOC_PISPD_KP</p></td>
<td><p>Proportional coefficient for PI controller for speed</p></td>
</tr>
<tr class="row-odd"><td><p>FOC_PISPD_KI</p></td>
<td><p>Integral coefficient for PI controller for speed</p></td>
</tr>
<tr class="row-even"><td><p>FOC_PISPD_MAX</p></td>
<td><p>Maximum value output from PI controller for speed</p></td>
</tr>
<tr class="row-odd"><td><p>FOC_PISPD_MIN</p></td>
<td><p>Minimum value output from PI controller for speed</p></td>
</tr>
<tr class="row-even"><td><p>FOC_PISPD_DIV</p></td>
<td><p>PI controller for speed Execution divider from FOC control loop frequency</p></td>
</tr>
<tr class="row-odd"><td><p>FOC_PIIQ_KP</p></td>
<td><p>Proportional coefficient for PI controller for Iq</p></td>
</tr>
<tr class="row-even"><td><p>FOC_PIIQ_KI</p></td>
<td><p>Integral coefficient for PI controller for Iq</p></td>
</tr>
<tr class="row-odd"><td><p>FOC_PIIQ_MAX</p></td>
<td><p>Maximum value output from PI controller for Iq</p></td>
</tr>
<tr class="row-even"><td><p>FOC_PIIQ_MIN</p></td>
<td><p>Minimum value output from PI controller for Iq</p></td>
</tr>
<tr class="row-odd"><td><p>FOC_PIID_KP</p></td>
<td><p>Proportional coefficient for PI controller for Id</p></td>
</tr>
<tr class="row-even"><td><p>FOC_PIID_KI</p></td>
<td><p>Integral coefficient for PI controller for Id</p></td>
</tr>
<tr class="row-odd"><td><p>FOC_PIID_MAX</p></td>
<td><p>Maximum value output from PI controller for Id</p></td>
</tr>
<tr class="row-even"><td><p>FOC_PIID_MIN</p></td>
<td><p>Minimum value output from PI controller for Id</p></td>
</tr>
</tbody>
</table>
</section>
<section id="selecting-the-build-levels">
<h3>2.3 Selecting the Build levels<a class="headerlink" href="#selecting-the-build-levels" title="Permalink to this heading">¶</a></h3>
<p>This software package uses an incremental system build to demonstrate a complete fixed-point sensorless Field Oriented control solution. There are 5 selectable build levels choices to incrementally verify the functioning.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Build Levels</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>LEVEL1</p></td>
<td><p>Module functionality check out.</p></td>
</tr>
<tr class="row-odd"><td><p>LEVEL2</p></td>
<td><p>Verify ADC, park/clarke, calibrate the offset.</p></td>
</tr>
<tr class="row-even"><td><p>LEVEL3</p></td>
<td><p>Verify closed current(torque) loop and PIDs and speed measurement.</p></td>
</tr>
<tr class="row-odd"><td><p>LEVEL4</p></td>
<td><p>Verify speed estimation and rotor position estimation.</p></td>
</tr>
<tr class="row-even"><td><p>LEVEL5</p></td>
<td><p>Verify closed speed loop, speed PID and eSMO.</p></td>
</tr>
</tbody>
</table>
<p>To select a build level in foc.h, click Project -&gt; Properties in the toolbar. In the Properties window, go to Build -&gt; Arm Compiler -&gt; Predefined Symbols. The pre-defined BUILDLEVEL name is LEVEL5. To change the pre-defined build level, click “Edit” and change LEVEL5 to another defined build level in foc.h.</p>
<figure class="align-default" id="id5">
<img alt="Build levels" src="../_images/FOC_BUILD_LEVELS.jpg" />
<figcaption>
<p><span class="caption-number">Fig. 4 </span><span class="caption-text">Build levels</span><a class="headerlink" href="#id5" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
</section>
<section id="important-note">
<h3>Important Note<a class="headerlink" href="#important-note" title="Permalink to this heading">¶</a></h3>
<p>The build levels are only used for verifying the modules. While using a build level lower than LEVEL5, the user should only use the motor in a no-load condition. The user should use LEVEL5 as final build level for the user to test the motor in loaded conditions.</p>
</section>
<section id="variables-for-controlling-motor">
<h3>2.4 Variables for controlling motor<a class="headerlink" href="#variables-for-controlling-motor" title="Permalink to this heading">¶</a></h3>
<p>Below are the list of variables to include in the debug window for controlling the motor. Note, for variables in IQ24 type, set the type by right clicking the variables and changing to IQ type 24.</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Variables</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Type</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>enableFOC</p></td>
<td><p>Control whether FOC is enabled or disabled. If set 0, PWM is disabled and the drive is in HighZ state. If set 1, The PWM output is set as per the FOC code.</p></td>
<td><p>boolean</p></td>
</tr>
<tr class="row-odd"><td><p>lsw</p></td>
<td><p>Controls the FOC state. If set 0, Aligns the motor to A phase. If set 1, Rotates the motor in open loop with speed from speedRef variable. If set 2, Rotates the motor in closed loop with speed from speedRef variable. lsw=2 is not applicable to Build levels other than LEVEL5 and should not be set.</p></td>
<td><p>int</p></td>
</tr>
<tr class="row-even"><td><p>idRef</p></td>
<td><p>Set the align current in per unit.</p></td>
<td><p>IQ24</p></td>
</tr>
<tr class="row-odd"><td><p>iqRef</p></td>
<td><p>Set the q axis current in lsw = 1 in per unit.</p></td>
<td><p>IQ24</p></td>
</tr>
<tr class="row-even"><td><p>speedRef</p></td>
<td><p>Sets the reference speed, used in open loop acceleration and in lsw = 2</p></td>
<td><p>IQ24</p></td>
</tr>
<tr class="row-odd"><td><p>speedEst.EstimatedSpeed</p></td>
<td><p>Display the estimated motor speed in per unit.</p></td>
<td><p>IQ24</p></td>
</tr>
<tr class="row-even"><td><p>speedEst.EstimatedSpeedRpm</p></td>
<td><p>Display the estimated motor speed in RPM.</p></td>
<td><p>int</p></td>
</tr>
<tr class="row-odd"><td><p>piSpd.Kp</p></td>
<td><p>Proportional constant in PI for Speed.</p></td>
<td><p>IQ24</p></td>
</tr>
<tr class="row-even"><td><p>piSpd.Ki</p></td>
<td><p>Integral constant in PI for Speed.</p></td>
<td><p>IQ24</p></td>
</tr>
<tr class="row-odd"><td><p>piId.Kp</p></td>
<td><p>Proportional constant in PI for Id current.</p></td>
<td><p>IQ24</p></td>
</tr>
<tr class="row-even"><td><p>piId.Ki</p></td>
<td><p>Integral constant in PI for Id current.</p></td>
<td><p>IQ24</p></td>
</tr>
<tr class="row-odd"><td><p>piIq.Kp</p></td>
<td><p>Proportional constant in PI for Iq current.</p></td>
<td><p>IQ24</p></td>
</tr>
<tr class="row-even"><td><p>piIq.Ki</p></td>
<td><p>Integral constant in PI for Iq current.</p></td>
<td><p>IQ24</p></td>
</tr>
<tr class="row-odd"><td><p>guiOverCurrentLimit</p></td>
<td><p>Value of phase current in ampere above which software triggers overcurrent</p></td>
<td><p>float</p></td>
</tr>
<tr class="row-even"><td><p>guiVmOverVoltageLimit</p></td>
<td><p>Value of voltage in volts above which software triggers overvoltage fault.</p></td>
<td><p>float</p></td>
</tr>
<tr class="row-odd"><td><p>guiVmUnderVoltageLimit</p></td>
<td><p>Value of voltage in volts below which software triggers undervoltage fault.</p></td>
<td><p>float</p></td>
</tr>
<tr class="row-even"><td><p>gui_faults.clearFault</p></td>
<td><p>if set 1, clears all the fault bits.</p></td>
<td><p>bool</p></td>
</tr>
<tr class="row-odd"><td><p>gui_faults.drvFault</p></td>
<td><p>Set when drv fault is detected.</p></td>
<td><p>bool</p></td>
</tr>
<tr class="row-even"><td><p>gui_faults.uvlo</p></td>
<td><p>Set when undervoltage is detected.</p></td>
<td><p>bool</p></td>
</tr>
<tr class="row-odd"><td><p>gui_faults.ovlo</p></td>
<td><p>Set when overvoltage is detected.</p></td>
<td><p>bool</p></td>
</tr>
<tr class="row-even"><td><p>gui_faults.ocp</p></td>
<td><p>Set when overcurrent is detected.</p></td>
<td><p>bool</p></td>
</tr>
</tbody>
</table>
</section>
<section id="running-the-motor">
<h3>2.5 Running the motor<a class="headerlink" href="#running-the-motor" title="Permalink to this heading">¶</a></h3>
<p>Below is the steps to run the motor:</p>
<ol class="arabic simple">
<li><p>Check if enableFOC = 0.</p></li>
<li><p>Check if any fault bit in the “gui_faults” structure is set. If any fault is set, clear the fault by setting gui_faults.clearFault = 1.</p></li>
<li><p>Set idRef to desired Align current.</p></li>
<li><p>Set iqRef to desired open loop current.</p></li>
<li><p>Set speedRef to desired open loop speed.</p></li>
<li><p>Set lsw = 0 to align the motor to the A phase. Note with enableFOC = 0, the FOC is disabled currently.</p></li>
<li><p>Set enableFOC = 1 to enable the FOC code to actuate the PWM. Because lsw = 0, we should see positive current in the A phase and half of the negative current in the B and C phases. If current is not constant, see PI tuning for Id.</p></li>
<li><p>Set lsw = 1 to switch to open loop. The motor starts to spin and ramp to the speed set in speedRef. If the motor is vibrating, reset to lsw = 0 and set a higher IdRef value. The current in the A phase should be sinusoidal. If there are spikes in current or distorted waveforms, see PI tuning for Iq.</p></li>
<li><p>Set lsw = 2 to switch to closed loop. The estimated motor speed (speedEst.EstimatedSpeed) should match speedRef across load conditions and the motor should continue to run smoothly.</p></li>
<li><p>Increase or decrease speedRef to run the desired motor speed. Check if the motor speed is stable after the ramp and no oscillations in speed occur, especially if load is applied. If the motor speed is unstable or there are oscillations in the final speed, use the speed PI controller to modify the speed control response.</p></li>
<li><p>To stop the motor, set enableFOC = 0.</p></li>
<li><p>If a fault occurs, the corresponding fault will be set in the gui_faults structure.</p></li>
<li><p>To clear the fault, remove the fault condition and set gui_faults.clearFault. The corresponding fault bit will be cleared.</p></li>
</ol>
</section>
<section id="tuning-the-motor">
<h3>2.6 Tuning the motor<a class="headerlink" href="#tuning-the-motor" title="Permalink to this heading">¶</a></h3>
</section>
<section id="tuning-pi-controllers">
<h3>Tuning PI controllers<a class="headerlink" href="#tuning-pi-controllers" title="Permalink to this heading">¶</a></h3>
<p>There are three PI controllers for Speed, Id current and Iq current. For tuning a PI controller, the user should first adjust the Kp first and then adjust the Ki for that PI controller. To tune the PI controllers:</p>
<ul class="simple">
<li><p>Use lsw = 0 to tune PI Id gains (piId.kp, piId.ki)</p></li>
<li><p>Use lsw = 1 to tune PI Iq gains (piIq.kp, piIq.ki)</p></li>
<li><p>Use lsw = 2 in PI speed gains (piSpd.kp, piSpd.ki)</p></li>
</ul>
</section>
<section id="logging-the-variables">
<h3>2.7 Logging the variables<a class="headerlink" href="#logging-the-variables" title="Permalink to this heading">¶</a></h3>
<p>The user can add the __ENABLE_LOG predefined symbol to enable logging. The user can set the log index and variable as shown in the below code:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">FOC_addVarToLog</span><span class="p">(</span><span class="n">FOC_LOG_IDX_0</span><span class="p">,</span> <span class="n">phaseVolt</span><span class="o">.</span><span class="n">Valpha</span><span class="p">);</span>
</pre></div>
</div>
<p>To see the logged data as a graph, the user can add the variable cssLog[X], where X is the index. Right click the variable and select “Graph”.</p>
<figure class="align-default" id="id6">
<img alt="Image of graph" src="../_images/CCS_GRAPH.jpg" />
<figcaption>
<p><span class="caption-number">Fig. 5 </span><span class="caption-text">Image of graph</span><a class="headerlink" href="#id6" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>Select “Continuous Refresh” mode to see continuous data.</p>
<figure class="align-default" id="id7">
<img alt="Image of graph" src="../_images/CCS_GRAPH_CONT_REFRESH.jpg" />
<figcaption>
<p><span class="caption-number">Fig. 6 </span><span class="caption-text">Image of graph</span><a class="headerlink" href="#id7" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p><strong>Note that the software consumes 24KB extra space in SRAM to store the values when logging is enabled.</strong></p>
</section>
<section id="access-spi-register">
<h3>2.8 Access SPI Register<a class="headerlink" href="#access-spi-register" title="Permalink to this heading">¶</a></h3>
<p>The software allows to independently change values in the SPI registers of the DRV. There are 3 options of writing to SPI register. Below are the variables and examples to use.</p>
<p>There are 3 options in SPI register:</p>
<ol class="arabic simple">
<li><p>Write 8-bit data to register</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Variables</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>gui_spi.writeRegFlag</p></td>
<td><p>Writes the register when set to 1.</p></td>
</tr>
<tr class="row-odd"><td><p>gui_spi.writeRegAddr</p></td>
<td><p>Set address of register to write.</p></td>
</tr>
<tr class="row-even"><td><p>gui_spi.writeRegData</p></td>
<td><p>Set data of register to write.</p></td>
</tr>
</tbody>
</table>
<p>For example, to write 0x01 to the Gate Drive HS register, select gui_spi.writeRegAddr as DRV8323RS_REG_ADDR_GATE_DRIVE_HS, set gui_spi.writeRegData = 0x01, and then set gui_spi.writeRegFlag = 1.</p>
<ol class="arabic simple" start="2">
<li><p>Update some bits in SPI register</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Variables</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>gui_spi.writeBitfieldRegFlag</p></td>
<td><p>Writes the bitfield when set to 1.</p></td>
</tr>
<tr class="row-odd"><td><p>gui_spi.writeBitfieldRegAddr</p></td>
<td><p>Set register address to write Bitfield.</p></td>
</tr>
<tr class="row-even"><td><p>gui_spi.bitfieldRegPosData</p></td>
<td><p>Set position of Bitfield to write.</p></td>
</tr>
<tr class="row-odd"><td><p>gui_spi.bitfieldRegMaskData</p></td>
<td><p>Set mask of Bitfield to write.</p></td>
</tr>
<tr class="row-even"><td><p>gui_spi.writeBitfieldRegData</p></td>
<td><p>Set data of Bitfield to write.</p></td>
</tr>
</tbody>
</table>
<p>For setting IDRIVEP_HS = 0x03 register, select gui_spi.writeBitfieldRegAddr as DRV8323RS_REG_ADDR_GATE_DRIVE_HS, set gui_spi.bitfieldRegPosData = 0x04, set gui_spi.bitfieldRegMaskData = 0x03, set gui_spi.writeBitfieldRegData = 0x03 and then set gui_spi.writeBitfieldRegFlag = 1.</p>
<ol class="arabic simple" start="3">
<li><p>Read SPI register</p></li>
</ol>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Variables</p></th>
<th class="head"><p>Description</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>gui_spi.readRegFlag</p></td>
<td><p>Reads the register when set to 1.</p></td>
</tr>
<tr class="row-odd"><td><p>gui_spi.readRegAddr</p></td>
<td><p>Set address of register to read.</p></td>
</tr>
<tr class="row-even"><td><p>gui_spi.readRegData</p></td>
<td><p>Shows data read from register.</p></td>
</tr>
</tbody>
</table>
<p>For reading the Gate Driver HS register, select gui_spi.readRegAddr as DRV8323RS_REG_ADDR_GATE_DRIVE_HS, and then set gui_spi.writeRegFlag = 1. The data read can be seen in gui_spi.readRegData.</p>
</section>
</section>
<section id="api-guide">
<h2>3. API Guide<a class="headerlink" href="#api-guide" title="Permalink to this heading">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="../../doxygen/api_guide/html/index.html">Sensorless FOC API Guide</a></p></li>
</ul>
</section>
<section id="known-issues">
<h2>4. Known Issues<a class="headerlink" href="#known-issues" title="Permalink to this heading">¶</a></h2>
<ol class="arabic simple">
<li><p>Function implicit declaration warning for IQrepeat function while compiling.</p></li>
<li><p>Current solution supports power up to 100W. Applying high torque at low speeds can cause motor to spin backwards with high rpm.</p></li>
</ol>
</section>
<section id="supported-devices">
<h2>5. Supported Devices<a class="headerlink" href="#supported-devices" title="Permalink to this heading">¶</a></h2>
<section id="drv8323rs">
<h3>DRV8323RS<a class="headerlink" href="#drv8323rs" title="Permalink to this heading">¶</a></h3>
<p>Supported MSPM0 Launchpads</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.ti.com/tool/LP-MSPM0G3507">LP-MSPM0G3507</a></p></li>
</ul>
<p>Links</p>
<ul class="simple">
<li><p><a class="reference external" href="drv8323rs/DRV8323RS_Hardware_User_Guide_CN.html">Hardware User Guide</a></p></li>
<li><p><a class="reference external" href="drv8323rs/DRV8323RS_GUI_User_Guide_CN.html">GUI User Guide</a></p></li>
<li><p><a class="reference external" href="https://dev.ti.com/gallery/view/TIMSPGC/MSPM0G-DRV8323RS-EVM-GUI">MSPM0G3507-DRV8323RS-EVM-GUI</a></p></li>
</ul>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Sensorless FOC Motor Control User Guide" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="drv8323rs/DRV8323RS_GUI_User_Guide_CN.html" class="btn btn-neutral float-right" title="DRV8323RS GUI User Guide" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 1995-2023, Texas Instruments Incorporated. All rights reserved.</p>
  </div>

   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>